<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .container {
            padding: 1rem;
            background-color: #ffffff;
            color: #333333;
        }

        .tab-content {
            margin-top: 1rem;
        }

        #expandAllContainer {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-bottom: 10px;
        }

        #clearLogBtn {
            background-color: #f1f3f4;
            color: #202124;
            border: none;
            padding: 4px 8px;
            font-size: 0.7rem;
            cursor: pointer;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            margin-left: auto;
        }

        #logList {
            padding: 0;
            margin: 0;
            list-style-type: none;
        }

        #logList li {
            position: relative;
            padding: 0.4rem 0.6rem;
            padding-bottom: 1.2rem;
            border: none;
            border-bottom: 1px solid #e0e0e0;
            background-color: #f9f9f9;
        }

        .log-time {
            position: absolute;
            bottom: 0.2rem;
            right: 0.6rem;
            font-size: 0.5rem;
            color: #666666;
            white-space: nowrap;
        }

        .log-message {
            margin-bottom: 0.2rem;
            text-align: left;
            word-wrap: break-word;
            font-size: 0.9rem;
            color: #333333;
            position: relative;
            transition: all 0.3s ease;
            overflow: hidden;
            cursor: pointer;
        }

        .truncated {
            max-height: 3em;
            white-space: nowrap;
            text-overflow: ellipsis;
            overflow: hidden;
        }

        .expanded {
            max-height: none;
            white-space: normal;
            overflow: visible;
        }

        .toggle-arrow {
            position: absolute;
            right: 0.6rem;
            top: 0.2rem;
            font-size: 1em;
            color: #1a73e8;
            cursor: pointer;
            user-select: none;
        }

        .toggle-arrow:hover {
            color: #0b66d4;
        }

        .btn {
            margin-right: 0.4rem;
            font-size: 0.75rem;
            padding: 0.2rem 0.4rem;
            background-color: #1a73e8;
            color: white;
            border: none;
        }

        .btn:hover {
            background-color: #0b66d4;
        }

        .config-content {
            background-color: #f9f9f9;
            padding: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }

        .config-item {
            margin-bottom: 1rem;
        }

        .config-item label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: bold;
        }

        .config-item input,
        .config-item select,
        .config-item textarea {
            width: 100%;
            padding: 0.4rem;
            font-size: 1rem;
            border: 1px solid #cccccc;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Modal for missing fields -->
        <div class="modal fade" id="missingFieldsModal" tabindex="-1" aria-labelledby="missingFieldsModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="missingFieldsModalLabel">Missing Required Fields</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <ul id="missingFieldsList" class="list-group">
                            <!-- Missing field names will be dynamically added here -->
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab navigation -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link active" id="messages-tab" data-bs-toggle="tab" href="#messages" role="tab"
                    aria-controls="messages" aria-selected="true">Messages</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="config-tab" data-bs-toggle="tab" href="#config" role="tab"
                    aria-controls="config" aria-selected="false">Config</a>
            </li>
        </ul>

        <!-- Tab content -->
        <div class="tab-content">
            <!-- Messages Tab -->
            <div class="tab-pane fade show active" id="messages" role="tabpanel" aria-labelledby="messages-tab">
                <!-- Input fields container -->
                <div id="inputContainer" class="mb-3">
                    <!-- Dynamic input fields will be inserted here -->
                </div>

                <!-- Buttons container -->
                <div id="buttonContainer" class="mb-2">
                    <!-- Dynamic buttons will be inserted here -->
                </div>

                <div id="expandAllContainer">
                    <div>
                        <input type="checkbox" id="expandAll">
                        <label for="expandAll">Expand All</label>
                    </div>
                    <button id="clearLogBtn">Clear</button>
                </div>

                <ul id="logList" class="list-group"></ul>
            </div>

            <!-- Config Tab -->
            <div class="tab-pane fade" id="config" role="tabpanel" aria-labelledby="config-tab">
                <div id="configContent" class="config-content">
                    <p>Loading configuration...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS, Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.min.js"></script>

    <script>
        const createLogServer = (
            log = console.log,
            debug = console.log,
            error = console.log,
            target = google.script.run,
            defaultPollInterval = 1250
        ) => {

            if (!log || !debug || !error) {
                throw new Error('Log, debug, and error functions cannot be null.');
            }

            if (defaultPollInterval <= 0) {
                throw new Error('Polling interval must be greater than zero.');
            }

            class Config {
                constructor(log, debug, error) {
                    this.log = log;
                    this.debug = debug;
                    this.error = error;
                }
            }

            const configInstance = new Config(log, debug, error);

            const doOneTimePoll = (interval, processId) => {
                setTimeout(() => {
                    google.script.run
                        .withSuccessHandler(response => {
                            configInstance.debug(`client received: [${processId}] ${JSON.stringify(response)}`);
                            if (response.messages && response.messages.length > 0) {
                                response.messages.forEach(msg => msg && configInstance.log(msg));
                            }
                        })
                        .getProcessStatus(processId);
                }, interval);
            };

            const handler = {
                get: function (target, prop) {
                    return function (...args) {
                        const processId = new Date().getTime().toString();

                        const pollInterval = setInterval(() => {
                            google.script.run
                                .withSuccessHandler(response => {
                                    configInstance.debug(`client received: [${processId}] ${JSON.stringify(response)}`);
                                    if (response.messages && response.messages.length > 0) {
                                        response.messages.forEach(msg => msg && configInstance.log(msg));
                                        doOneTimePoll(75, processId);
                                    }
                                })
                                .getProcessStatus(processId);
                        }, defaultPollInterval);

                        const onSuccess = () => {
                            clearInterval(pollInterval);
                            console.log(`${prop} completed successfully`);

                            doOneTimePoll(10, processId);
                        };

                        const onError = (err) => {
                            clearInterval(pollInterval);
                            console.log( `Error: ${prop}: ${err.message}` || 'An error occurred.');

                            doOneTimePoll(10, processId);
                        };

                        target
                            .withSuccessHandler(onSuccess)
                            .withFailureHandler(onError)
                            .invokeWithId(prop, processId, ...args);
                    }
                }
            };

            return new Proxy(target, handler);
        }

        function updateInputsWithUserProperties(properties) {
            if (typeof properties === 'string' && properties === 'No configuration found.') {
                alert('No configuration found.');
                return;
            }

            // Loop through the properties and set the values in the appropriate input fields
            for (let key in properties) {
                const inputId = key.split('_')[1]; // Assuming the format is functionName_arg1, functionName_arg2, etc.
                $(`#input-${inputId}`).val(properties[key]);
            }
        }

        (function ($) {
            const LogInterface = (function () {
                let server = null;
                const specificButtonConfigs = [];
                const inputFieldMap = {}; // Used to track shared input fields by argument name
                let lastLogTimestamp = null; // Declaring lastLogTimestamp here

                function init() {
                    // Initialize the log server
                    server = createLogServer((message) => addToLogList(message, 'info'));

                    // Generate input fields and buttons
                    generateInputsAndButtons();

                    // Bind event handlers for interaction
                    bindEventHandlers();

                    // Initialize timestamp updates
                    initializeMidnightTimer();

                    // Call to load configuration
                    loadAllConfigs();  // This is the new call to handle all configurations
                }
                async function loadAllConfigs() {
                    try {
                        // Iterate through each button configuration and load the properties for each function
                        for (const config of specificButtonConfigs) {
                            console.log(`Loading config for function: ${config.functionName}`);
                            await loadConfigForFunction(config.functionName, config.args);  // Await the result for each function
                        }
                        console.log("Configuration load completed.");
                    } catch (error) {
                        console.error("Error loading configurations:", error.message);
                        alert("An error occurred while loading configurations. Please check the console for more details.");
                    }
                }
                async function loadConfigForFunction(functionName, args) {
                    try {
                        // Simulate an async call to the server to fetch user properties
                        const properties = await server.getUserPropertiesForFunction(functionName);

                        // Check if properties are found and are valid
                        if (properties && typeof properties === 'object') {
                            args.forEach(arg => {
                                const inputId = `input-${functionName}-${arg.label}`;
                                
                                // Populate input fields with saved properties
                                if (properties[inputId]) {
                                    $(`#${inputId}`).val(properties[inputId]);
                                }
                            });
                            return properties;  // Return the properties after successful population
                        } else {
                            console.log("No user properties found for function:", functionName);
                            return null;  // Return null if no properties found
                        }
                    } catch (err) {
                        // Catch and log any error that occurs
                        console.error("Failed to load user properties for function:", functionName, err);
                        throw new Error(`Error while loading configuration for function ${functionName}: ${err.message}`);
                    }
                }


                // Function to update the config tab with properties
                function updateConfigTab(properties) {
                    if (typeof properties === 'string') {
                        // If the server returns the message "No configuration found", display it
                        $('#configContent').html(`<p style="color: red;">${properties}</p>`);
                    } else {
                        // Else populate the form with the user properties
                        $('#configContent').empty(); // Clear the content
                        for (let key in properties) {
                            const inputId = key.split('_')[1];  // Assuming the format is functionName_arg1, functionName_arg2, etc.
                            $('#configContent').append(`
                                <div class="form-group">
                                    <label for="input-${inputId}">${inputId}</label>
                                    <input id="input-${inputId}" class="form-control" value="${properties[key]}">
                                </div>
                            `);
                        }
                    }
                }
                function addButtonConfig(config) {
                    specificButtonConfigs.push(config);
                }

               function generateInputsAndButtons() {
                  specificButtonConfigs.forEach(config => {
                      // Create a Bootstrap card or grouping box if groupLabel is specified
                      const groupBox = $('<div>').addClass('card mb-3'); // Bootstrap card to represent the group box

                      if (config.groupLabel) {
                          const cardHeader = $('<div>').addClass('card-header').text(config.groupLabel); // Add group label as card header
                          groupBox.append(cardHeader);
                      }

                      const cardBody = $('<div>').addClass('card-body'); // Body for the content inside the card (inputs and buttons)

                      config.args.forEach(arg => {
                          const inputId = `input-${config.functionName}-${arg.label.replace(/\s+/g, '-')}`; // Replace spaces with dashes

                          const input = $('<input>')
                              .attr('type', arg.type)
                              .addClass('form-control mb-2')
                              .attr('placeholder', arg.label)
                              .attr('id', inputId);

                          const formGroup = $('<div>').addClass('form-group').append(
                              $('<label>').attr('for', inputId).text(arg.label), // Added the 'for' attribute to label
                              input
                          );

                          cardBody.append(formGroup);

                          inputFieldMap[inputId] = input;
                      });

                      const button = $('<button>')
                          .addClass('btn btn-primary btn-sm')
                          .text(config.label || config.functionName)
                          .attr('data-function', config.functionName)
                          .click(handleButtonClick);

                      cardBody.append(button);
                      groupBox.append(cardBody);
                      $('#inputContainer').append(groupBox);

                      // Load user properties for this specific function
                      loadConfigForFunction(config.functionName, config.args);
                  });
              }


                function handleButtonClick(event) {
                    const button = $(event.currentTarget);
                    const functionName = button.attr('data-function');
                    const config = specificButtonConfigs.find(config => config.functionName === functionName);
                    const missingFields = [];
                    let firstMissingField = null;

                    // Validate required fields
                    config.args.forEach(arg => {
                        const inputId = `input-${config.functionName}-${arg.label.replace(/\s+/g, '-')}`;
                        const input = $(`#${inputId}`);  // Use the dynamically generated ID
                        const label = $(`label[for="${inputId}"]`);

                        // Debugging: Ensure the input element exists
                        if (!input.length) {
                            console.error(`Input field for ${arg.label} not found!`);
                            return;
                        }

                        console.log(`Checking field: ${arg.label}`);  // Log field being checked
                        console.log(`Input value: ${input.val()}`);  // Log the actual input value

                        // Check for required fields and specific handling for 'date' type fields
                        if (arg.required && (!input.val() || (input[0].type === 'date' && input[0].value === ""))) {
                            missingFields.push(arg.label);
                            console.log(`${arg.label} is missing or invalid.`);  // Log missing/invalid fields

                            // Highlight missing field label
                            label.css('color', 'red');

                            // Store the first missing field for scrolling
                            if (!firstMissingField) {
                                firstMissingField = input;
                            }
                        } else {
                            console.log(`${arg.label} is filled correctly.`);  // Log valid fields
                            // Reset label color if field is filled
                            label.css('color', '');
                        }
                    });

                    if (missingFields.length > 0) {
                        console.log(`Missing fields: ${missingFields.join(', ')}`);  // Log all missing fields

                        // Show modal with missing fields
                        $('#missingFieldsList').empty();
                        missingFields.forEach(field => {
                            $('#missingFieldsList').append(`<li class="list-group-item">${field}</li>`);
                        });
                        $('#missingFieldsModal').modal('show');

                        // Scroll to first missing field only if it exists
                        if (firstMissingField && firstMissingField.length) {
                            firstMissingField.focus();
                            $('html, body').animate({
                                scrollTop: firstMissingField.offset().top - 100
                            }, 600);
                        }

                        return; // Prevent function call if fields are missing
                    }

                    // Invoke the function if all required fields are filled
                    const inputs = config.args.map(arg => $(`#input-${config.functionName}-${arg.label.replace(/\s+/g, '-')}`).val());
                    console.log(`Invoking ${functionName} with inputs:`, inputs);

                    // Invoke the real user Server side function
                    server[functionName](...inputs);

                    // Save the user properties
                    saveUserPropertiesForFunction(functionName, inputs);
                }




                function saveUserPropertiesForFunction(functionName, inputs) {
                    const properties = {};
                    inputs.forEach((inputValue, index) => {
                        const argName = specificButtonConfigs
                            .find(config => config.functionName === functionName)
                            .args[index].label;
                        properties[`input-${functionName}-${argName}`] = inputValue;
                    });

                    server.saveUserProperties(functionName, properties);
                }

                function addToLogList(message, type = 'info', maxLines = 1000) {
                    const MAX_MESSAGE_LENGTH = 100; // Define the maximum length for a log message
                    const now = new Date();
                    const timestamp = now.toISOString();
                    const currentSeconds = now.getSeconds();
                    let formattedTime = '';

                    if (!lastLogTimestamp || lastLogTimestamp !== currentSeconds) {
                        formattedTime = formatTimestamp(timestamp);
                        lastLogTimestamp = currentSeconds;
                    }

                    // Determine if the message needs to be truncated
                    const isTruncated = message.length > MAX_MESSAGE_LENGTH;
                    const displayMessage = isTruncated ? message.substring(0, MAX_MESSAGE_LENGTH) + '...' : message;

                    // Construct the log message HTML
                    const listItem = `
                        <li class="list-group-item list-group-item-${type}" data-timestamp="${timestamp}">
                            <div class="log-message ${isTruncated ? 'truncated' : ''}">
                                ${displayMessage}
                                ${isTruncated ? `<span class="toggle-arrow"><i class="bi bi-chevron-right"></i></span>` : ''}
                            </div>
                            ${formattedTime ? `<div class="log-time">${formattedTime}</div>` : ''}
                        </li>
                    `;

                    $("#logList").prepend(listItem);

                    if (typeof maxLines === 'number') {
                        while ($("#logList li").length > maxLines) {
                            $("#logList li:last-child").remove();
                        }
                    }
                }


                function bindEventHandlers() {
                    $('#clearLogBtn').click(() => $('#logList').empty());

                    $('#expandAll').change(function () {
                        if ($(this).is(":checked")) {
                            $("#logList .log-message.truncated").each(function () {
                                $(this).removeClass('truncated').addClass('expanded');
                                $(this).find('.toggle-arrow i').removeClass('bi-chevron-right').addClass('bi-chevron-up');
                            });
                        } else {
                            $("#logList .log-message.expanded").each(function () {
                                $(this).removeClass('expanded').addClass('truncated');
                                $(this).find('.toggle-arrow i').removeClass('bi-chevron-up').addClass('bi-chevron-right');
                            });
                        }
                    });

                    $("#logList").on('click', '.toggle-arrow', function () {
                        const messageDiv = $(this).closest('.log-message');
                        const isTruncated = messageDiv.hasClass('truncated');

                        if (isTruncated) {
                            messageDiv.removeClass('truncated').addClass('expanded');
                            $(this).find('i').removeClass('bi-chevron-right').addClass('bi-chevron-up');
                        } else {
                            messageDiv.removeClass('expanded').addClass('truncated');
                            $(this).find('i').removeClass('bi-chevron-up').addClass('bi-chevron-right');
                        }

                        updateExpandAllCheckbox();
                    });

                    $("#logList").on('keypress', '.toggle-arrow', function (e) {
                        if (e.key === 'Enter' || e.key === ' ') {
                            $(this).click();
                        }
                    });
                }

                function formatTimestamp(timestamp) {
                    const date = new Date(timestamp);
                    const now = new Date();

                    if (isSameDay(date, now)) {
                        return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
                    } else {
                        return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()} ` +
                            `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
                    }
                }

                function isSameDay(date1, date2) {
                    return date1.getFullYear() === date2.getFullYear() &&
                        date1.getMonth() === date2.getMonth() &&
                        date1.getDate() === date2.getDate();
                }

                function initializeMidnightTimer() {
                    const msUntilMidnight = getMillisecondsUntilMidnight();

                    setTimeout(function () {
                        updateAllTimestamps();
                        setInterval(updateAllTimestamps, 24 * 60 * 60 * 1000);
                    }, msUntilMidnight);
                }

                function getMillisecondsUntilMidnight() {
                    const now = new Date();
                    const nextMidnight = new Date(
                        now.getFullYear(),
                        now.getMonth(),
                        now.getDate() + 1,
                        0, 0, 0, 0
                    );
                    return nextMidnight - now;
                }

                function updateAllTimestamps() {
                    $("#logList li").each(function () {
                        const timestamp = $(this).attr('data-timestamp');
                        const formattedTime = formatTimestamp(timestamp);
                        $(this).find('.log-time').text(formattedTime);
                    });
                }

                function updateExpandAllCheckbox() {
                    const total = $("#logList .log-message").length;
                    const expanded = $("#logList .log-message.expanded").length;

                    if (expanded === total && total > 0) {
                        $("#expandAll").prop('checked', true).prop('indeterminate', false);
                    } else if (expanded === 0) {
                        $("#expandAll").prop('checked', false).prop('indeterminate', false);
                    } else {
                        $("#expandAll").prop('indeterminate', true);
                    }
                }

                return {
                    init: init,
                    addButtonConfig: addButtonConfig
                };
            })();

            $(document).ready(function () {
                LogInterface.addButtonConfig({
                    label: 'Start Process',
                    functionName: 'longRunningFunction',
                    groupLabel: 'Process Controls',
                    args: [
                        { label: 'Start Date', type: 'date' },
                        { label: 'End Date', type: 'date', required: true }
                    ]
                });

                LogInterface.init();
            });
        })(jQuery);
    </script>
</body>

</html>
